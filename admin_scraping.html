<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Scraped Jobs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Use the same Supabase CDN as admin.html -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background:#f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .top-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .card { transition: transform 0.2s; }
    .card:hover { transform: translateY(-5px); }
    .import-btn { min-width: 140px; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div class="top-bar">
      <h2>Scraped Job Notifications</h2>
      <div>
        <span id="admin-email" class="me-3 fw-bold text-primary"></span>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
      </div>
    </div>
    <div class="mb-3">
      <button id="refreshBtn" class="btn btn-primary">Refresh Scraped Jobs</button>
      <span id="status" class="ms-3 text-muted fw-bold"></span>
    </div>
    <div id="jobs-list">
      <div class="alert alert-info">Loading jobs...</div>
    </div>
  </div>

  <script>
    // === SUPABASE CONFIG (same as admin.html) ===
    const SUPABASE_URL = 'https://enfzymosvlrmfluwidbj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuZnp5bW9zdmxybWZsdXdpZGJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTU1ODYsImV4cCI6MjA3NzkzMTU4Nn0._Mf8tyGBmcVgYPDTinF-UVD-HJD3-9OB90IAPJ5Dyx4';

    // CORRECT WAY: Use window.supabase.createClient (matches admin.html)
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Utility: Escape HTML
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // Status message
    function setStatus(msg, isError = false) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.style.color = isError ? 'crimson' : '#28a745';
      if (msg) setTimeout(() => { if (el.textContent === msg) el.textContent = ''; }, 5000);
    }

    // Fetch and display scraped jobs
    async function fetchScrapedJobs() {
      setStatus('Loading scraped jobs...');
      const { data: jobs, error } = await supabase
        .from('scraped_jobs')
        .select('id,title,source,deadline,url,description,application_link,created_at')
        .order('created_at', { ascending: false });

      if (error) {
        setStatus('Error: ' + error.message, true);
        console.error('Supabase error:', error);
        document.getElementById('jobs-list').innerHTML = `<div class="alert alert-danger">Failed to load jobs: ${escapeHtml(error.message)}</div>`;
        return;
      }

      const container = document.getElementById('jobs-list');
      if (!jobs || jobs.length === 0) {
        container.innerHTML = '<div class="alert alert-info">No scraped jobs found.</div>';
        setStatus('No jobs available');
        return;
      }

      container.innerHTML = jobs.map(job => {
        const title = escapeHtml(job.title || 'Untitled');
        const source = escapeHtml(job.source || 'Unknown');
        const deadline = escapeHtml(job.deadline || 'N/A');
        const url = job.url ? escapeHtml(job.url) : '#';
        const description = escapeHtml(job.description || '').substring(0, 300) + (job.description?.length > 300 ? '...' : '');
        const created_at = new Date(job.created_at).toLocaleString();

        return `
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h5 class="card-title mb-1">${title}</h5>
                  <div class="text-muted small mb-2">
                    Source: <strong>${source}</strong> • 
                    Deadline: <strong>${deadline}</strong> • 
                    Added: ${created_at}
                  </div>
                  <p class="card-text text-secondary">${description || '<em>No description</em>'}</p>
                </div>
                <div class="text-end ms-3">
                  <a href="${url}" target="_blank" rel="noopener" class="btn btn-outline-primary btn-sm mb-2">View Original</a>
                  <br/>
                  <button class="btn btn-success btn-sm import-btn" onclick='importJob(${JSON.stringify(job)})'>
                    Import to Site
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      setStatus(`Loaded ${jobs.length} scraped job(s)`);
    }

    // Import job to main admin form
    function importJob(job) {
      if (!job || !job.title) return alert("Invalid job data");
      
      if (confirm(`Import this job?\n\nTitle: ${job.title}\nSource: ${job.source || 'Unknown'}`)) {
        localStorage.setItem('importedJob', JSON.stringify(job));
        alert('Job cached! Opening main admin panel...');
        window.location.href = '/admin.html#job-form';
      }
    }

    // Authentication check
    async function requireAuth() {
      const { data } = await supabase.auth.getSession();
      const session = data?.session;

      if (!session) {
        alert('You must be logged in to access this page.');
        window.location.href = '/admin.html';
        return false;
      }

      // Display email
      const email = session.user?.email || 'Admin';
      document.getElementById('admin-email').textContent = `Signed in as ${email}`;

      return true;
    }

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
      window.location.href = '/admin.html';
    });

    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', fetchScrapedJobs);

    // On load
    window.addEventListener('load', async () => {
      const authenticated = await requireAuth();
      if (authenticated) {
        fetchScrapedJobs();
      }
    });
  </script>
</body>
</html>
