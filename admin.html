<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NEI Admin - Secure Login</title>
  <link rel="stylesheet" href="css/style.css">
 <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/module/index.js'
  
  const supabaseUrl = 'https://enfzymosvlrmfluwidbj.supabase.co'
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVuZnp5bW9zdmxybWZsdXdpZGJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNTU1ODYsImV4cCI6MjA3NzkzMTU4Nn0._Mf8tyGBmcVgYPDTinF-UVD-HJD3-9OB90IAPJ5Dyx4'
  
  const supabase = createClient(supabaseUrl, supabaseKey)
  window.supabase = supabase
</script>
  <style>
    body { 
      background: linear-gradient(135deg, #667eea, #764ba2); 
      height: 100vh; margin: 0; display: flex; align-items: center; justify-content: center; 
      font-family: 'Segoe UI', sans-serif; 
    }
    .login-box { 
      background: white; padding: 3rem; border-radius: 20px; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; 
      max-width: 420px; width: 90%; 
    }
    .logo { font-size: 4rem; margin-bottom: 0.5rem; color: #667eea; font-weight: bold; }
    h2 { color: #333; margin-bottom: 1rem; }
    input { 
      width: 100%; padding: 1rem; margin: 1rem 0; border: 2px solid #ddd; 
      border-radius: 50px; font-size: 1.1rem; text-align: center; box-sizing: border-box;
    }
    .btn { 
      background: #667eea; color: white; padding: 1rem 2rem; border: none; 
      border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; 
      font-size: 1.2rem; transition: 0.3s;
    }
    .btn:hover { background: #5a67d8; }
    .hidden { display: none; }
    .logout { float: right; background: #e74c3c; padding: 0.6rem 1.2rem; border-radius: 50px; color: white; font-size: 0.9rem; }
    .admin-panel { max-width: 1100px; margin: 2rem auto; background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.2rem; margin-top: 1.5rem; }
    .full-width { grid-column: span 2; }
    label { font-weight: 600; color: #444; }
    input, select, textarea { padding: 0.9rem; border: 1px solid #ccc; border-radius: 10px; font-size: 1rem; }
    .btn-save { background: #667eea; margin-top: 1rem; }
    .job-entry { background: #f8f9fa; padding: 1.2rem; border-radius: 12px; margin: 1rem 0; border-left: 5px solid #667eea; }
    .job-status { padding: 0.3rem 0.8rem; border-radius: 20px; font-weight: bold; font-size: 0.8rem; }
    .status-start { background: #d4edda; color: #155724; }
    .status-closing { background: #f8d7da; color: #721c24; }
    .status-out { background: #d1ecf1; color: #0c5460; }
    .status-soon { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div class="login-box" id="login-screen">
    <div class="logo">NEI</div>
    <h2>Admin Portal</h2>
    <p>Login with your credentials</p>
    
    <input type="email" id="email" placeholder="Email" value="admin@neijobportal.in">
    <input type="password" id="password" placeholder="Password" value="nei2025ultra">
    
    <button class="btn" onclick="login()">LOGIN NOW</button>
    
    <p style="margin-top:1.5rem; color:#666; font-size:0.9rem;">
      Default: <strong>admin@neijobportal.in</strong> / <strong>nei2025ultra</strong>
    </p>
  </div>

  <!-- ADMIN PANEL -->
  <div id="admin-panel" class="hidden">
    <div class="container">
      <div class="admin-panel">
        <h1>NEI Job Portal - Admin Panel 
          <button class="logout" onclick="logout()">Logout</button>
        </h1>
        <p><strong>Welcome back!</strong> You're in full control.</p>

        <!-- FULL FORM + JOBS LIST -->
        <div class="form-grid">
          <div><label>State</label>
            <select id="state" onchange="showFields(); checkAutofill();">
              <option value="">-- Select --</option>
              <option value="assam">Assam</option>
              <option value="arunachal-pradesh">Arunachal Pradesh</option>
              <option value="nagaland">Nagaland</option>
              <option value="manipur">Manipur</option>
              <option value="mizoram">Mizoram</option>
              <option value="tripura">Tripura</option>
              <option value="meghalaya">Meghalaya</option>
              <option value="sikkim">Sikkim</option>
              <option value="central-govt">Central Govt</option>
            </select>
          </div>
          <div><label>Category</label>
            <select id="category" onchange="showFields(); checkAutofill();">
              <option value="">-- Select --</option>
              <option value="latestJobs">Latest Jobs</option>
              <option value="results">Results</option>
              <option value="admitCards">Admit Cards</option>
              <option value="answerKeys">Answer Key</option>
              <option value="centralGovtJobs">Central Govt Jobs</option>
              <option value="privateJobs">Private Jobs</option>
            </select>
          </div>
          <div class="full-width"><label>Title</label><input id="title" placeholder="APSC CCE 2025"></div>
          <div><label>Post</label><input id="postName"></div>
          <div><label>Vacancy</label><input id="vacancy"></div>
          <div><label>Last Date</label><input id="lastDate"></div>
          <div><label>Fee</label><input id="fee"></div>
          <div><label>Age</label><input id="age"></div>
          <div><label>Salary</label><input id="salary"></div>
          <div class="full-width"><label>Eligibility</label><textarea id="eligibility"></textarea></div>
          <div class="full-width"><label>Dates (one per line)</label><textarea id="dates"></textarea></div>
          <div><label>Official</label><input id="official"></div>
          <div><label>Apply</label><input id="apply"></div>
          <div><label>Notification</label><input id="notification"></div>
          
          <div class="full-width hidden" id="result-fields">
            <label>Result Desc</label><textarea id="resultDesc"></textarea>
            <label>Result Link</label><input id="resultLink">
          </div>
          <div class="full-width hidden" id="answerkey-fields">
            <label>Answer Key Desc</label><textarea id="answerKeyDesc"></textarea>
            <label>Answer Key Link</label><input id="answerKeyLink">
          </div>
          <div class="full-width hidden" id="admitcard-fields">
            <label>Admit Card Desc</label><textarea id="admitCardDesc"></textarea>
            <label>Admit Card Link</label><input id="admitCardLink">
          </div>
          
          <div class="full-width">
            <label>Status</label>
            <select id="status">
              <option value="start">Start (Green)</option>
              <option value="closing">Closing (Red)</option>
              <option value="out">Out (Blue)</option>
              <option value="soon">Soon (Yellow)</option>
            </select>
          </div>
          
          <button class="btn-save" onclick="saveJob()">SAVE JOB</button>
          <button class="btn-delete hidden" onclick="cancelEdit()">CANCEL</button>
        </div>

        <h3 style="margin-top:3rem;">All Jobs</h3>
        <div style="margin:1rem 0;">
          <input type="text" id="search" placeholder="Search jobs..." onkeyup="searchJobs()" style="padding:0.8rem; width:70%; border-radius:50px; border:1px solid #ddd;">
        </div>
        <div id="jobs-list"></div>
        <div id="pagination" style="text-align:center; margin:2rem 0;"></div>
      </div>
    </div>
  </div>

  <script>
    let jobs = [];
    let editingId = null;

    // SUPABASE AUTH LOGIN (EMAIL + PASSWORD)
    async function login() {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) return alert("Enter email & password!");

      const { data, error } = await supabase.auth.signInWithPassword({
        email: email,
        password: password
      });

      if (error) {
        alert("Login failed: " + error.message);
        console.error(error);
        return;
      }

      if (data.user.email !== 'admin@neijobportal.in') {
        alert("Access denied. Only main admin allowed.");
        await supabase.auth.signOut();
        return;
      }

      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('admin-panel').classList.remove('hidden');
      loadJobs();
      alert("Welcome back, Admin!");
    }

    async function logout() {
      await supabase.auth.signOut();
      document.getElementById('admin-panel').classList.add('hidden');
      document.getElementById('login-screen').classList.remove('hidden');
    }

    // AUTO LOGIN CHECK
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' && session?.user?.email === 'admin@neijobportal.in') {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        loadJobs();
      }
    });

    // LOAD JOBS
    async function loadJobs() {
      const { data, error } = await supabase.from('jobs').select('*').order('id', { ascending: false });
      if (error) return alert("Load error: " + error.message);
      jobs = data;
      displayJobs();
    }

    function displayJobs(filter = '') {
      const filtered = jobs.filter(j => 
        j.title.toLowerCase().includes(filter) || 
        j.postName.toLowerCase().includes(filter)
      );
      const list = document.getElementById('jobs-list');
      list.innerHTML = filtered.map(job => `
        <div class="job-entry">
          <strong>${job.title}</strong> | ${job.postName} | ${job.vacancy} posts<br>
          <span class="job-status status-${job.status}">${job.statusText || 'N/A'}</span>
          <button onclick="editJob(${job.id})" style="background:#f39c12; color:white; padding:0.4rem 0.8rem; border:none; border-radius:50px; margin-left:1rem;">Edit</button>
          <button onclick="deleteJob(${job.id})" style="background:#e74c3c; color:white; padding:0.4rem 0.8rem; border:none; border-radius:50px;">Delete</button>
        </div>
      `).join('') || "<p>No jobs found.</p>";
    }

    function searchJobs() {
      const query = document.getElementById('search').value.toLowerCase();
      displayJobs(query);
    }

    function showFields() {
      const cat = document.getElementById('category').value;
      document.getElementById('result-fields').classList.toggle('hidden', cat !== 'results');
      document.getElementById('answerkey-fields').classList.toggle('hidden', cat !== 'answerKeys');
      document.getElementById('admitcard-fields').classList.toggle('hidden', cat !== 'admitCards');
    }

    function checkAutofill() { loadJobs(); }

    async function saveJob() {
      const job = {
        state: document.getElementById('state').value === 'central-govt' ? 'central-govt' : document.getElementById('state').value,
        category: document.getElementById('category').value,
        title: document.getElementById('title').value,
        postName: document.getElementById('postName').value || "Various",
        vacancy: document.getElementById('vacancy').value || "Multiple",
        lastDate: document.getElementById('lastDate').value || "Soon",
        fee: document.getElementById('fee').value,
        age: document.getElementById('age').value,
        salary: document.getElementById('salary').value,
        eligibility: document.getElementById('eligibility').value,
        dates: document.getElementById('dates').value.split('\n').filter(Boolean),
        official: document.getElementById('official').value,
        apply: document.getElementById('apply').value,
        notification: document.getElementById('notification').value,
        status: document.getElementById('status').value,
        statusText: {start:'Apply Now', closing:'Last Date', out:'Out', soon:'Soon'}[document.getElementById('status').value]
      };

      if (job.category === 'results') {
        job.resultDesc = document.getElementById('resultDesc').value;
        job.resultLink = document.getElementById('resultLink').value;
      }
      if (job.category === 'answerKeys') {
        job.answerKeyDesc = document.getElementById('answerKeyDesc').value;
        job.answerKeyLink = document.getElementById('answerKeyLink').value;
      }
      if (job.category === 'admitCards') {
        job.admitCardDesc = document.getElementById('admitCardDesc').value;
        job.admitCardLink = document.getElementById('admitCardLink').value;
      }

      const { error } = editingId 
        ? await supabase.from('jobs').update(job).eq('id', editingId)
        : await supabase.from('jobs').insert(job);

      if (error) alert("Error: " + error.message);
      else {
        alert(editingId ? "Updated!" : "Added!");
        editingId = null;
        document.querySelectorAll('input, textarea, select').forEach(el => el.value = '');
        document.getElementById('state').value = '';
        document.getElementById('category').value = '';
        showFields();
        loadJobs();
      }
    }

    async function editJob(id) {
      const { data } = await supabase.from('jobs').select('*').eq('id', id).single();
      if (!data) return;
      editingId = id;
      document.getElementById('state').value = data.state === 'central-govt' ? 'central-govt' : data.state;
      document.getElementById('category').value = data.category;
      document.getElementById('title').value = data.title;
      document.getElementById('postName').value = data.postName;
      document.getElementById('vacancy').value = data.vacancy;
      document.getElementById('lastDate').value = data.lastDate;
      document.getElementById('fee').value = data.fee;
      document.getElementById('age').value = data.age;
      document.getElementById('salary').value = data.salary;
      document.getElementById('eligibility').value = data.eligibility;
      document.getElementById('dates').value = data.dates.join('\n');
      document.getElementById('official').value = data.official;
      document.getElementById('apply').value = data.apply;
      document.getElementById('notification').value = data.notification;
      document.getElementById('status').value = data.status;
      showFields();
    }

    async function deleteJob(id) {
      if (confirm("Delete forever?")) {
        await supabase.from('jobs').delete().eq('id', id);
        loadJobs();
      }
    }

    function cancelEdit() {
      editingId = null;
      document.querySelectorAll('input, textarea, select').forEach(el => el.value = '');
      document.getElementById('state').value = '';
      document.getElementById('category').value = '';
      showFields();
    }

    // Press Enter to login
    document.getElementById('password').addEventListener('keypress', e => {
      if (e.key === 'Enter') login();
    });
  </script>
</body>
</html>
